# Toolchain versions managed by mise.

[tools]
# Runtimes
go = "1.25.1"
lefthook = "2.0.15"

# Go tooling (installed via go install)
"go:github.com/golangci/golangci-lint/cmd/golangci-lint" = "latest"
"go:mvdan.cc/gofumpt" = "latest"
"go:golang.org/x/tools/cmd/goimports" = "latest"
"go:github.com/air-verse/air" = "latest"

[env]
_.path = ["~/.local/bin"]

[tasks.setup]
description = "Prepare local development environment (hooks/tools only)"
run = "lefthook install"

[tasks.lint]
description = "Run Go linter with project config"
run = "golangci-lint run ./..."

[tasks.build]
description = "Build esb CLI binary"
run = "go build -o esb ./cmd/esb"

[tasks.install]
description = "Install esb binary to ~/.local/bin"
run = [
  "mise run build",
  "mkdir -p $HOME/.local/bin",
  "if [ -f $HOME/.local/bin/esb ]; then mv $HOME/.local/bin/esb $HOME/.local/bin/esb.old; fi",
  "cp esb $HOME/.local/bin/esb",
  "rm -f $HOME/.local/bin/esb.old",
  "echo 'âœ“ Installed to $HOME/.local/bin/esb'",
]

[tasks.test]
description = "Run Go tests"
run = "go test ./..."

[tasks.dev]
description = "Rebuild and install esb automatically on file changes"
run = "air"

[tasks.audit_deadcode]
description = "Report unreachable functions from the esb CLI entrypoint"
run = "go run golang.org/x/tools/cmd/deadcode@latest -test ./cmd/esb"

[tasks.audit_dupl]
description = "Run duplicate-code audits (prod blocking + test report)"
run = ["mise run audit_dupl_prod", "mise run audit_dupl_tests"]

[tasks.audit_dupl_prod]
description = "Detect duplicate code in production (non-test) files"
run = "golangci-lint run ./... --config .golangci.dupl.prod.yml"

[tasks.audit_dupl_tests]
description = "Report duplicate code in test files (non-blocking)"
run = "golangci-lint run ./... --config .golangci.dupl.yml || true"

[tasks.audit_refactor]
description = "Run deadcode and duplicate-code audits"
run = ["mise run audit_deadcode", "mise run audit_dupl"]
