# syntax=docker/dockerfile:1.7
# Auto-generated by SAM Template Generator
# DO NOT EDIT MANUALLY - Regenerate with: esb build
# Source: template.yaml
# FunctionName: {{ .Name }}

ARG COMPONENT=function
ARG IMAGE_RUNTIME=shared

FROM alpine:3.20 AS build-meta

ARG COMPONENT
ARG IMAGE_RUNTIME

RUN apk add --no-cache git ca-certificates python3

WORKDIR /work

RUN --mount=type=bind,from=trace_tools,source=.,target=/trace_tools \
    --mount=type=bind,from=git_dir,source=.,target=/gitdir \
    --mount=type=bind,from=git_common,source=.,target=/gitcommon \
    python3 /trace_tools/generate_version_json.py \
      --output /out/version.json \
      --git-dir /gitdir \
      --git-common-dir /gitcommon \
      --component "${COMPONENT}" \
      --image-runtime "${IMAGE_RUNTIME}"

FROM {{ .BaseImage }}

# ESB Runtime
COPY {{ .SitecustomizeSource }} /opt/python/sitecustomize.py

COPY --from=build-meta /out/version.json /app/version.json

{{- range .Layers }}
# Layer: {{ .Name }}
COPY {{ .ContentURI }}/ /opt/
{{- end }}
{{- if .HasRequirements }}

# Function dependencies
COPY {{ .CodeURI }}requirements.txt ${LAMBDA_TASK_ROOT}/
RUN pip install -r ${LAMBDA_TASK_ROOT}/requirements.txt
{{- end }}

# Function code
COPY {{ .CodeURI }} ${LAMBDA_TASK_ROOT}/

# Handler
CMD [ "{{ .Handler }}" ]
